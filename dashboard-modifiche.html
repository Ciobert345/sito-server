<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>⚙️ Config Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            black: "#000000",
            white: "#ffffff"
          },
          boxShadow: {
            subtle: "0 0 0 1px rgba(255,255,255,0.08)",
          },
        }
      }
    }
  </script>
  <meta name="color-scheme" content="dark">
  <style>
    html, body { background: #000; }
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    .tab-active { background: rgba(255,255,255,0.1); }
    .hidden { display: none; }
    .drop-hover { outline: 2px dashed rgba(255,255,255,0.35); outline-offset: -6px; }
  </style>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>⚙️</text></svg>">
</head>
<body class="bg-black text-white min-h-screen">
  <header class="border-b border-white/20">
    <div class="max-w-6xl mx-auto px-4 py-5 flex items-center justify-between gap-3">
      <h1 class="text-xl sm:text-2xl font-semibold tracking-tight">⚙️ Config Dashboard</h1>
      <div class="flex-1"></div>
      <button id="saveBtn" class="inline-flex items-center gap-2 border border-white rounded-md px-4 py-2 text-sm font-medium transition-colors hover:bg-white hover:text-black focus:outline-none focus:ring-2 focus:ring-white/60">
        <span>Salva</span>
      </button>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8 sm:py-10 space-y-8">
    <nav class="flex items-center gap-2 border border-white/10 rounded-lg p-1 bg-black/40">
      <button data-tab="roadmap" class="tabBtn tab-active border border-white/10 rounded-md px-3 py-2 text-sm">Roadmap</button>
      <button data-tab="downloads" class="tabBtn border border-white/10 rounded-md px-3 py-2 text-sm">Download</button>
      <button data-tab="countdown" class="tabBtn border border-white/10 rounded-md px-3 py-2 text-sm">Countdown</button>
      <button data-tab="banners" class="tabBtn border border-white/10 rounded-md px-3 py-2 text-sm">InfoBanners</button>
    </nav>

    <!-- ROADMAP -->
    <section id="tab-roadmap" class="rounded-xl border border-white/20 bg-black/40 backdrop-blur-sm p-5 sm:p-6">
      <div class="mb-4 flex items-center justify-between gap-2">
        <h2 class="text-lg font-medium">Roadmap</h2>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4" id="roadmapColumns">
        <div class="col border border-white/10 rounded-lg p-3" data-col="backlog">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-semibold" id="title-backlog">Backlog</h3>
            <div class="flex items-center gap-2">
              <button class="addInCol inline-flex items-center border border-white/30 rounded px-2 py-1 text-xs" data-target="backlog">+ Aggiungi</button>
              <span class="text-xs text-white/50" id="count-backlog">0</span>
            </div>
          </div>
          <div class="space-y-2" id="list-backlog"></div>
        </div>
        <div class="col border border-white/10 rounded-lg p-3" data-col="nextup">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-semibold" id="title-nextup">Next Up</h3>
            <div class="flex items-center gap-2">
              <button class="addInCol inline-flex items-center border border-white/30 rounded px-2 py-1 text-xs" data-target="nextup">+ Aggiungi</button>
              <span class="text-xs text-white/50" id="count-nextup">0</span>
            </div>
          </div>
          <div class="space-y-2" id="list-nextup"></div>
        </div>
        <div class="col border border-white/10 rounded-lg p-3" data-col="inprogress">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-semibold" id="title-inprogress">In Progress</h3>
            <div class="flex items-center gap-2">
              <button class="addInCol inline-flex items-center border border-white/30 rounded px-2 py-1 text-xs" data-target="inprogress">+ Aggiungi</button>
              <span class="text-xs text-white/50" id="count-inprogress">0</span>
            </div>
          </div>
          <div class="space-y-2" id="list-inprogress"></div>
        </div>
        <div class="col border border-white/10 rounded-lg p-3" data-col="done">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-semibold" id="title-done">Done</h3>
            <div class="flex items-center gap-2">
              <button class="addInCol inline-flex items-center border border-white/30 rounded px-2 py-1 text-xs" data-target="done">+ Aggiungi</button>
              <span class="text-xs text-white/50" id="count-done">0</span>
            </div>
          </div>
          <div class="space-y-2" id="list-done"></div>
        </div>
      </div>

      <div class="mt-6 border-t border-white/10 pt-4">
        <h3 class="text-sm font-semibold mb-3">Nuovo elemento</h3>
        <form id="newRoadmapForm" class="grid grid-cols-1 md:grid-cols-5 gap-3">
          <input required id="rmTitle" class="md:col-span-2 bg-black border border-white/30 rounded-md px-3 py-2 text-sm placeholder-white/40" placeholder="Titolo" />
          <select id="rmType" class="bg-black border border-white/30 rounded-md px-3 py-2 text-sm">
            <option value="Feature">Feature</option>
            <option value="Miglioramento">Miglioramento</option>
            <option value="Bugfix">Bugfix</option>
          </select>
          <select id="rmPriority" class="bg-black border border-white/30 rounded-md px-3 py-2 text-sm">
            <option value="Bassa">Bassa</option>
            <option value="Media">Media</option>
            <option value="Alta">Alta</option>
          </select>
          <select id="rmColumn" class="bg-black border border-white/30 rounded-md px-3 py-2 text-sm">
            <option value="backlog">Backlog</option>
            <option value="nextup">Next Up</option>
            <option value="inprogress">In Progress</option>
            <option value="done">Done</option>
          </select>
          <button class="md:col-span-1 inline-flex items-center justify-center gap-2 border border-white rounded-md px-4 py-2 text-sm font-medium transition-colors hover:bg-white hover:text-black">Aggiungi</button>
        </form>
      </div>
    </section>

    <!-- DOWNLOAD LINKS -->
    <section id="tab-downloads" class="rounded-xl border border-white/20 bg-black/40 backdrop-blur-sm p-5 sm:p-6 hidden">
      <h2 class="text-lg font-medium mb-4">Download Modpack</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="border border-white/10 rounded-lg p-4">
          <h3 class="text-sm font-semibold mb-3">CurseForge</h3>
          <label class="block text-xs text-white/60 mb-1">Modpack URL</label>
          <input id="dl_curse_modpack" class="w-full bg-black border border-white/30 rounded-md px-3 py-2 text-sm mb-3" placeholder="https://..." />
          <label class="block text-xs text-white/60 mb-1">Launcher URL</label>
          <input id="dl_curse_launcher" class="w-full bg-black border border-white/30 rounded-md px-3 py-2 text-sm" placeholder="https://..." />
        </div>
        <div class="border border-white/10 rounded-lg p-4">
          <h3 class="text-sm font-semibold mb-3">Modrinth</h3>
          <label class="block text-xs text-white/60 mb-1">Modpack URL</label>
          <input id="dl_modrinth_modpack" class="w-full bg-black border border-white/30 rounded-md px-3 py-2 text-sm mb-3" placeholder="https://..." />
          <label class="block text-xs text-white/60 mb-1">Launcher URL</label>
          <input id="dl_modrinth_launcher" class="w-full bg-black border border-white/30 rounded-md px-3 py-2 text-sm" placeholder="https://..." />
        </div>
        <div class="border border-white/10 rounded-lg p-4">
          <h3 class="text-sm font-semibold mb-3">SKLauncher</h3>
          <label class="block text-xs text-white/60 mb-1">Modpack URL</label>
          <input id="dl_sk_modpack" class="w-full bg-black border border-white/30 rounded-md px-3 py-2 text-sm mb-3" placeholder="https://..." />
          <label class="block text-xs text-white/60 mb-1">Launcher URL</label>
          <input id="dl_sk_launcher" class="w-full bg-black border border-white/30 rounded-md px-3 py-2 text-sm" placeholder="https://..." />
        </div>
        <div class="border border-white/10 rounded-lg p-4">
          <h3 class="text-sm font-semibold mb-3">Update</h3>
          <label class="block text-xs text-white/60 mb-1">Latest URL</label>
          <input id="dl_update_latest" class="w-full bg-black border border-white/30 rounded-md px-3 py-2 text-sm" placeholder="https://..." />
        </div>
      </div>
    </section>

    <!-- COUNTDOWN -->
    <section id="tab-countdown" class="rounded-xl border border-white/20 bg-black/40 backdrop-blur-sm p-5 sm:p-6 hidden">
      <h2 class="text-lg font-medium mb-4">Countdown</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="border border-white/10 rounded-lg p-4">
          <label class="inline-flex items-center gap-2 mb-3">
            <input type="checkbox" id="cd_enabled" class="h-4 w-4 accent-white" />
            <span class="text-sm">Abilitato</span>
          </label>
          <label class="block text-xs text-white/60 mb-1">Data (es: September 17, 2025 19:38:00)</label>
          <input id="cd_date" class="w-full bg-black border border-white/30 rounded-md px-3 py-2 text-sm mb-3" placeholder="September 17, 2025 19:38:00" />
          <label class="block text-xs text-white/60 mb-1">Titolo</label>
          <input id="cd_title" class="w-full bg-black border border-white/30 rounded-md px-3 py-2 text-sm mb-3" placeholder="Aggiornamento in arrivo" />
          <label class="block text-xs text-white/60 mb-1">Messaggio scadenza</label>
          <input id="cd_expired" class="w-full bg-black border border-white/30 rounded-md px-3 py-2 text-sm" placeholder="Il server è ora disponibile!" />
        </div>
      </div>
    </section>

    <!-- INFO BANNERS -->
    <section id="tab-banners" class="rounded-xl border border-white/20 bg-black/40 backdrop-blur-sm p-5 sm:p-6 hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-medium">InfoBanners</h2>
        <button id="addBannerBtn" class="inline-flex items-center gap-2 border border-white rounded-md px-3 py-1.5 text-sm transition-colors hover:bg-white hover:text-black">+ Nuovo banner</button>
      </div>
      <div id="bannersList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </section>
  </main>

  <!-- Toast -->
  <div id="toast" class="fixed top-4 right-4 z-50 hidden">
    <div id="toastInner" class="border border-white rounded-md bg-black text-white px-4 py-2 text-sm shadow-subtle"></div>
  </div>

  <template id="roadmapCardTemplate">
    <div class="rmCard border border-white/10 rounded-md p-3 bg-black/30" draggable="true">
      <div class="flex items-start justify-between gap-2">
        <div class="min-w-0">
          <div class="rmTitle text-sm font-medium truncate" contenteditable="true"></div>
          <div class="mt-1 flex flex-wrap items-center gap-2">
            <button type="button" class="rmType badge text-xs border border-white/30 rounded px-2 py-0.5"></button>
            <button type="button" class="rmPriority badge text-xs border border-white/30 rounded px-2 py-0.5"></button>
          </div>
        </div>
        <div class="flex flex-col items-end gap-2">
          <div class="flex items-center gap-2">
            <button class="rmRemove border border-white/40 text-white/80 hover:text-black hover:bg-white rounded px-2 py-1 text-xs" title="Rimuovi">Rimuovi</button>
          </div>
        </div>
      </div>
    </div>
  </template>

  <template id="bannerCardTemplate">
    <div class="bnCard border border-white/10 rounded-md p-4 bg-black/30">
      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0 flex-1">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-3">
              <label class="inline-flex items-center gap-2">
                <input type="checkbox" class="bnEnabled h-4 w-4 accent-white" />
                <span class="text-sm">Abilitato</span>
              </label>
              <span class="text-xs text-white/50 bnId"></span>
            </div>
            <button class="bnRemove border border-white/40 text-white/80 hover:text-black hover:bg-white rounded px-2 py-1 text-xs" title="Rimuovi">Rimuovi</button>
          </div>
          <label class="block text-xs text-white/60 mb-1">Titolo</label>
          <input class="bnTitle w-full bg-black border border-white/30 rounded-md px-3 py-2 text-sm mb-3" />
          <label class="block text-xs text-white/60 mb-1">Sottotitolo</label>
          <input class="bnSubtitle w-full bg-black border border-white/30 rounded-md px-3 py-2 text-sm mb-3" />
          <label class="block text-xs text-white/60 mb-1">Messaggio</label>
          <textarea rows="3" class="bnMessage w-full bg-black border border-white/30 rounded-md px-3 py-2 text-sm mb-3"></textarea>
        </div>
        <div class="w-56 shrink-0">
          <label class="block text-xs text-white/60 mb-1">Icona</label>
          <input class="bnIcon w-full bg-black border border-white/30 rounded-md px-3 py-2 text-sm mb-3" placeholder="notification" />
          <label class="block text-xs text-white/60 mb-1">Stile</label>
          <div class="flex items-center gap-2 mb-2">
            <button type="button" class="bnStyleChip border border-white/30 rounded px-2 py-1 text-xs" data-style="banner-yellow">Giallo</button>
            <button type="button" class="bnStyleChip border border-white/30 rounded px-2 py-1 text-xs" data-style="banner-purple">Viola</button>
            <button type="button" class="bnStyleChip border border-white/30 rounded px-2 py-1 text-xs" data-style="banner-blue">Blu</button>
          </div>
          <div class="flex items-center gap-2">
            <button type="button" class="bnStyleChip border border-white/30 rounded px-2 py-1 text-xs" data-style="banner-green">Verde</button>
            <button type="button" class="bnStyleChip border border-white/30 rounded px-2 py-1 text-xs" data-style="banner-red">Rosso</button>
          </div>
        </div>
      </div>
    </div>
  </template>

  <script>
    const CONFIG_URL = 'config.json';
    const SAVE_ENDPOINTS = ['/.netlify/functions/update-config', '/functions/update-config'];

    const tabButtons = document.querySelectorAll('.tabBtn');
    const sections = {
      roadmap: document.getElementById('tab-roadmap'),
      downloads: document.getElementById('tab-downloads'),
      countdown: document.getElementById('tab-countdown'),
      banners: document.getElementById('tab-banners'),
    };

    // Roadmap refs
    const roadmapCardTemplate = document.getElementById('roadmapCardTemplate');
    const listEls = {
      backlog: document.getElementById('list-backlog'),
      nextup: document.getElementById('list-nextup'),
      inprogress: document.getElementById('list-inprogress'),
      done: document.getElementById('list-done'),
    };
    const countEls = {
      backlog: document.getElementById('count-backlog'),
      nextup: document.getElementById('count-nextup'),
      inprogress: document.getElementById('count-inprogress'),
      done: document.getElementById('count-done'),
    };
    const titleEls = {
      backlog: document.getElementById('title-backlog'),
      nextup: document.getElementById('title-nextup'),
      inprogress: document.getElementById('title-inprogress'),
      done: document.getElementById('title-done'),
    };
    const newForm = document.getElementById('newRoadmapForm');
    const rmTitle = document.getElementById('rmTitle');
    const rmType = document.getElementById('rmType');
    const rmPriority = document.getElementById('rmPriority');
    const rmColumn = document.getElementById('rmColumn');

    // Download refs
    const dl = {
      curse_modpack: document.getElementById('dl_curse_modpack'),
      curse_launcher: document.getElementById('dl_curse_launcher'),
      modrinth_modpack: document.getElementById('dl_modrinth_modpack'),
      modrinth_launcher: document.getElementById('dl_modrinth_launcher'),
      sk_modpack: document.getElementById('dl_sk_modpack'),
      sk_launcher: document.getElementById('dl_sk_launcher'),
      update_latest: document.getElementById('dl_update_latest'),
    };

    // Countdown refs
    const cd_enabled = document.getElementById('cd_enabled');
    const cd_date = document.getElementById('cd_date');
    const cd_title = document.getElementById('cd_title');
    const cd_expired = document.getElementById('cd_expired');

    // Banners refs
    const bannersList = document.getElementById('bannersList');
    const bannerCardTemplate = document.getElementById('bannerCardTemplate');
    const addBannerBtn = document.getElementById('addBannerBtn');

    // Global
    const saveBtn = document.getElementById('saveBtn');
    const toast = document.getElementById('toast');
    const toastInner = document.getElementById('toastInner');

    let currentConfig = {};
    let roadmapItems = [];
    let roadmapColumns = [
      { id: 'backlog', title: 'Backlog' },
      { id: 'nextup', title: 'Next Up' },
      { id: 'inprogress', title: 'In Progress' },
      { id: 'done', title: 'Done' },
    ];

    function showToast(message, type = 'info') {
      toastInner.textContent = message;
      toastInner.className = 'border rounded-md bg-black text-sm px-4 py-2 ' + (type === 'error' ? 'border-red-400 text-red-200' : type === 'success' ? 'border-green-400 text-green-200' : 'border-white text-white');
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    function switchTab(name) {
      Object.entries(sections).forEach(([k, el]) => {
        if (k === name) el.classList.remove('hidden'); else el.classList.add('hidden');
      });
      tabButtons.forEach(btn => btn.classList.toggle('tab-active', btn.dataset.tab === name));
    }

    tabButtons.forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));

    // Utils get/set
    function get(obj, path, fallback) {
      try { return path.split('.').reduce((acc, k) => acc && acc[k], obj) ?? fallback; } catch { return fallback; }
    }
    function set(obj, path, value) {
      const keys = path.split('.');
      let cur = obj;
      for (let i = 0; i < keys.length - 1; i++) {
        const k = keys[i];
        if (typeof cur[k] !== 'object' || cur[k] === null) cur[k] = {};
        cur = cur[k];
      }
      cur[keys[keys.length - 1]] = value;
    }

    // Roadmap helpers (intuitive chips + drag & drop)
    const TYPE_OPTIONS = ['Feature', 'Miglioramento', 'Bugfix'];
    const PRI_OPTIONS = ['Bassa', 'Media', 'Alta'];
    function cycle(array, current) {
      const idx = array.indexOf(current);
      return array[(idx + 1) % array.length];
    }

    function attachRoadmapCardLogic(card, item) {
      const titleEl = card.querySelector('.rmTitle');
      const typeBtn = card.querySelector('.rmType');
      const priBtn = card.querySelector('.rmPriority');
      const removeBtn = card.querySelector('.rmRemove');

      titleEl.textContent = item.title || '';
      typeBtn.textContent = item.type || 'Feature';
      priBtn.textContent = item.priority || 'Media';

      titleEl.addEventListener('input', () => { item.title = titleEl.textContent.trim(); });
      typeBtn.addEventListener('click', () => { item.type = cycle(TYPE_OPTIONS, item.type || 'Feature'); typeBtn.textContent = item.type; });
      priBtn.addEventListener('click', () => { item.priority = cycle(PRI_OPTIONS, item.priority || 'Media'); priBtn.textContent = item.priority; });
      removeBtn.addEventListener('click', () => {
        const idx = roadmapItems.findIndex(x => x === item || x.id === item.id);
        if (idx >= 0) { roadmapItems.splice(idx, 1); renderRoadmap(); showToast('Elemento rimosso', 'success'); }
      });

      // Drag & drop
      card.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('text/plain', item.id || JSON.stringify(item));
        e.dataTransfer.effectAllowed = 'move';
      });
    }

    function createRoadmapCard(item) {
      const fragment = roadmapCardTemplate.content.cloneNode(true);
      const card = fragment.firstElementChild;
      attachRoadmapCardLogic(card, item);
      return card;
    }

    function applyRoadmapColumnTitles() {
      const map = {}; roadmapColumns.forEach(c => { map[c.id] = c.title; });
      Object.keys(titleEls).forEach(id => { if (map[id]) titleEls[id].textContent = map[id]; });
    }

    function renderRoadmap() {
      Object.values(listEls).forEach(el => el.innerHTML = '');
      const byCol = { backlog: [], nextup: [], inprogress: [], done: [] };
      for (const it of roadmapItems) { (byCol[it.column] || byCol.backlog).push(it); }
      Object.keys(byCol).forEach(col => {
        countEls[col].textContent = String(byCol[col].length);
        byCol[col].forEach(it => listEls[col].appendChild(createRoadmapCard(it)));
      });
    }

    function onAddRoadmapSubmit(e) {
      e.preventDefault();
      const title = rmTitle.value.trim(); if (!title) { showToast('Titolo obbligatorio', 'error'); return; }
      const item = { id: 'rm_' + Math.random().toString(36).slice(2,8), title, type: rmType.value, priority: rmPriority.value, column: rmColumn.value };
      roadmapItems.push(item); rmTitle.value = ''; renderRoadmap(); showToast('Elemento aggiunto', 'success');
    }

    function attachColumnDnD(colEl) {
      colEl.addEventListener('dragover', (e) => { e.preventDefault(); colEl.classList.add('drop-hover'); });
      colEl.addEventListener('dragleave', () => { colEl.classList.remove('drop-hover'); });
      colEl.addEventListener('drop', (e) => {
        e.preventDefault(); colEl.classList.remove('drop-hover');
        const id = e.dataTransfer.getData('text/plain');
        const item = roadmapItems.find(x => x.id === id);
        if (item) { item.column = colEl.dataset.col; renderRoadmap(); }
      });
    }

    function attachAddInColumnButtons() {
      document.querySelectorAll('.addInCol').forEach(btn => {
        btn.addEventListener('click', () => {
          const col = btn.getAttribute('data-target');
          const title = prompt('Titolo nuovo elemento');
          if (!title) return;
          const item = { id: 'rm_' + Math.random().toString(36).slice(2,8), title, type: 'Feature', priority: 'Media', column: col };
          roadmapItems.push(item); renderRoadmap();
        });
      });
    }

    // Downloads
    function renderDownloads() {
      const d = get(currentConfig, 'downloadLinks', {});
      dl.curse_modpack.value = get(d, 'curseforge.modpack', '') || '';
      dl.curse_launcher.value = get(d, 'curseforge.launcher', '') || '';
      dl.modrinth_modpack.value = get(d, 'modrinth.modpack', '') || '';
      dl.modrinth_launcher.value = get(d, 'modrinth.launcher', '') || '';
      dl.sk_modpack.value = get(d, 'sklauncher.modpack', '') || '';
      dl.sk_launcher.value = get(d, 'sklauncher.launcher', '') || '';
      dl.update_latest.value = get(d, 'update.latest', '') || '';
    }
    function collectDownloads() {
      set(currentConfig, 'downloadLinks.curseforge.modpack', dl.curse_modpack.value.trim());
      set(currentConfig, 'downloadLinks.curseforge.launcher', dl.curse_launcher.value.trim());
      set(currentConfig, 'downloadLinks.modrinth.modpack', dl.modrinth_modpack.value.trim());
      set(currentConfig, 'downloadLinks.modrinth.launcher', dl.modrinth_launcher.value.trim());
      set(currentConfig, 'downloadLinks.sklauncher.modpack', dl.sk_modpack.value.trim());
      set(currentConfig, 'downloadLinks.sklauncher.launcher', dl.sk_launcher.value.trim());
      set(currentConfig, 'downloadLinks.update.latest', dl.update_latest.value.trim());
    }

    // Countdown
    function renderCountdown() {
      const c = get(currentConfig, 'countdown', {});
      cd_enabled.checked = Boolean(c.enabled);
      cd_date.value = c.date || '';
      cd_title.value = c.title || '';
      cd_expired.value = c.expiredMessage || '';
    }
    function collectCountdown() {
      set(currentConfig, 'countdown.enabled', cd_enabled.checked);
      set(currentConfig, 'countdown.date', cd_date.value.trim());
      set(currentConfig, 'countdown.title', cd_title.value.trim());
      set(currentConfig, 'countdown.expiredMessage', cd_expired.value.trim());
    }

    // Banners
    function createBannerCard(b) {
      const fragment = bannerCardTemplate.content.cloneNode(true);
      const card = fragment.firstElementChild;
      card.querySelector('.bnId').textContent = b.id ? '#' + b.id : '';
      const bnEnabled = card.querySelector('.bnEnabled');
      const bnTitle = card.querySelector('.bnTitle');
      const bnSubtitle = card.querySelector('.bnSubtitle');
      const bnMessage = card.querySelector('.bnMessage');
      const bnIcon = card.querySelector('.bnIcon');
      const bnRemove = card.querySelector('.bnRemove');

      bnEnabled.checked = !!b.enabled;
      bnTitle.value = b.title || '';
      bnSubtitle.value = b.subtitle || '';
      bnMessage.value = b.message || '';
      bnIcon.value = b.icon || '';

      bnEnabled.addEventListener('change', () => { b.enabled = bnEnabled.checked; });
      bnTitle.addEventListener('input', () => { b.title = bnTitle.value; });
      bnSubtitle.addEventListener('input', () => { b.subtitle = bnSubtitle.value; });
      bnMessage.addEventListener('input', () => { b.message = bnMessage.value; });
      bnIcon.addEventListener('input', () => { b.icon = bnIcon.value; });
      bnRemove.addEventListener('click', () => {
        if (!Array.isArray(currentConfig.infoBanners)) return;
        const idx = currentConfig.infoBanners.findIndex(x => x === b || x.id === b.id);
        if (idx >= 0) { currentConfig.infoBanners.splice(idx, 1); renderBanners(); showToast('Banner rimosso', 'success'); }
      });

      // Quick style chips
      card.querySelectorAll('.bnStyleChip').forEach(chip => {
        chip.addEventListener('click', () => {
          const style = chip.getAttribute('data-style');
          b.style = style;
          showToast('Stile: ' + style, 'success');
        });
      });

      return card;
    }
    function renderBanners() {
      bannersList.innerHTML = '';
      const arr = Array.isArray(currentConfig.infoBanners) ? currentConfig.infoBanners : [];
      arr.forEach(b => bannersList.appendChild(createBannerCard(b)));
    }
    function addNewBanner() {
      if (!Array.isArray(currentConfig.infoBanners)) currentConfig.infoBanners = [];
      const newB = { id: 'banner' + (currentConfig.infoBanners.length + 1), enabled: false, title: '', subtitle: '', message: '', icon: 'notification', style: 'banner-blue' };
      currentConfig.infoBanners.push(newB);
      renderBanners();
    }

    // IO
    async function loadConfig() {
      try {
        const res = await fetch(CONFIG_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error('Impossibile caricare config.json');
        currentConfig = await res.json();
        const roadmapSection = get(currentConfig, 'feedbackRoadmap.sections.roadmap', {});
        roadmapItems = Array.isArray(roadmapSection.items) ? roadmapSection.items : [];
        roadmapColumns = Array.isArray(roadmapSection.columns) && roadmapSection.columns.length ? roadmapSection.columns : roadmapColumns;
        applyRoadmapColumnTitles();
        renderRoadmap();
        // Attach DnD and quick add per column
        document.querySelectorAll('#roadmapColumns .col').forEach(attachColumnDnD);
        attachAddInColumnButtons();
        renderDownloads();
        renderCountdown();
        renderBanners();
      } catch (e) {
        showToast('Errore caricamento configurazione', 'error');
      }
    }

    async function postToFirstAvailable(payload) {
      let lastErr = '';
      for (const url of SAVE_ENDPOINTS) {
        try {
          const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          const text = await res.text();
          if (res.ok) return { ok: true, text, url };
          lastErr = `HTTP ${res.status} ${res.statusText}: ${text || 'nessun corpo risposta'}`;
        } catch (e) { lastErr = e.message || String(e); }
      }
      return { ok: false, error: lastErr };
    }

    function collectAll() {
      // Roadmap
      set(currentConfig, 'feedbackRoadmap.sections.roadmap.items', roadmapItems);
      // Downloads
      collectDownloads();
      // Countdown
      collectCountdown();
      return currentConfig;
    }

    async function saveConfig() {
      try {
        const payload = collectAll();
        saveBtn.disabled = true; saveBtn.classList.add('opacity-60', 'cursor-not-allowed');
        const result = await postToFirstAvailable(payload);
        if (!result.ok) throw new Error(result.error || 'Salvataggio non riuscito');
        showToast('Configurazione salvata', 'success');
      } catch (e) {
        showToast('Salvataggio non riuscito: ' + (e.message || 'errore sconosciuto'), 'error');
      } finally {
        saveBtn.disabled = false; saveBtn.classList.remove('opacity-60', 'cursor-not-allowed');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadConfig();
      newForm.addEventListener('submit', onAddRoadmapSubmit);
      addBannerBtn.addEventListener('click', addNewBanner);
      saveBtn.addEventListener('click', saveConfig);
    });
  </script>
</body>
</html>


